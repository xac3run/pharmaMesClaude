<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nobilis.Tech MES</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    // Простые иконки через emoji
    const Icons = {
      Dashboard: () => <span>📊</span>,
      Batch: () => <span>🧪</span>,
      Template: () => <span>📋</span>,
      Workflow: () => <span>🔄</span>,
      Plus: () => <span>➕</span>,
      Edit: () => <span>✏️</span>,
      Save: () => <span>💾</span>,
      Trash: () => <span>🗑️</span>,
      Check: () => <span>✅</span>,
      Alert: () => <span>⚠️</span>,
      User: () => <span>👤</span>,
      Materials: () => <span>📦</span>
    };

    // ---------------------------
    // Main App
    // ---------------------------
    function App() {
      const [activeTab, setActiveTab] = useState("dashboard");
      const [batches, setBatches] = useState([
        { id: "BR-2024-001", product: "Aspirin 325mg", status: "in_progress", progress: 65 },
        { id: "BR-2024-002", product: "Paracetamol 500mg", status: "completed", progress: 100 },
        { id: "BR-2024-003", product: "Ibuprofen 200mg", status: "deviation", progress: 45, deviation: "Temp exceeded" }
      ]);

      const [templates, setTemplates] = useState([
        { id: 1, name: "Aspirin 325mg - Tableting", version: "1.0", status: "approved", steps: [] },
        { id: 2, name: "Paracetamol 500mg - Coating", version: "1.1", status: "draft", steps: [] }
      ]);

      const [workflow, setWorkflow] = useState([
        { id: 1, name: "Weighing", type: "input", param: "Weight", min: 320, max: 330, value: null, status: "pending" },
        { id: 2, name: "Compression", type: "instruction", status: "pending" },
        { id: 3, name: "Visual QC", type: "control", param: "Defects", min: 0, max: 5, value: null, status: "pending" }
      ]);

      // ---------------------------
      // Batches logic
      // ---------------------------
      const completeStep = (id) => {
        setBatches(prev => prev.map(b => b.id === id
          ? { ...b, progress: Math.min(b.progress + 30, 100), status: b.progress + 30 >= 100 ? "completed" : "in_progress" }
          : b
        ));
      };

      const reportDeviation = (id) => {
        setBatches(prev => prev.map(b => b.id === id
          ? { ...b, status: "deviation", deviation: "Manual deviation reported" }
          : b
        ));
      };

      // ---------------------------
      // Templates logic (🔥 NEW editable)
      // ---------------------------
      const addTemplate = () => {
        setTemplates(prev => [...prev, {
          id: Date.now(),
          name: "New Template",
          version: "0.1",
          status: "draft",
          steps: []
        }]);
      };

      const addStep = (tid) => {
        setTemplates(prev => prev.map(t =>
          t.id === tid
            ? { ...t, steps: [...t.steps, { id: Date.now(), name: "New Step", param: "", min: null, max: null, materials: [] }] }
            : t
        ));
      };

      const updateStep = (tid, sid, field, value) => {
        setTemplates(prev => prev.map(t =>
          t.id === tid
            ? { ...t, steps: t.steps.map(s => s.id === sid ? { ...s, [field]: value } : s) }
            : t
        ));
      };

      // ---------------------------
      // Workflow logic (🔥 NEW)
      // ---------------------------
      const updateWorkflowStep = (sid, value) => {
        setWorkflow(prev => prev.map(s =>
          s.id === sid
            ? {
                ...s,
                value,
                status:
                  s.type === "control"
                    ? (value >= s.min && value <= s.max ? "ok" : "blocked")
                    : "done"
              }
            : s
        ));
      };

      // ---------------------------
      // Render UI
      // ---------------------------
      return (
        <div className="p-6">
          {/* Header with logo */}
          <header className="flex items-center mb-6">
            <img src="assets/logo.svg" alt="Logo" className="h-10 mr-3" />
            <h1 className="text-3xl font-bold">Nobilis.Tech MES</h1>
          </header>

          {/* Navigation */}
          <nav className="flex space-x-4 border-b pb-2 mb-6">
            <button onClick={() => setActiveTab("dashboard")} className={activeTab === "dashboard" ? "font-bold" : ""}><Icons.Dashboard /> Dashboard</button>
            <button onClick={() => setActiveTab("batches")} className={activeTab === "batches" ? "font-bold" : ""}><Icons.Batch /> Batches</button>
            <button onClick={() => setActiveTab("templates")} className={activeTab === "templates" ? "font-bold" : ""}><Icons.Template /> eBR Templates</button>
            <button onClick={() => setActiveTab("workflow")} className={activeTab === "workflow" ? "font-bold" : ""}><Icons.Workflow /> Workflow</button>
          </nav>

          {/* Dashboard */}
          {activeTab === "dashboard" && (
            <div>
              <h2 className="text-xl font-semibold mb-4">📊 Production KPIs</h2>
              <ul className="list-disc ml-6">
                <li>Active batches: {batches.filter(b => b.status !== "completed").length}</li>
                <li>Completed: {batches.filter(b => b.status === "completed").length}</li>
                <li>Deviations: {batches.filter(b => b.status === "deviation").length}</li>
                <li>Templates: {templates.length}</li>
              </ul>
            </div>
          )}

          {/* Batches */}
          {activeTab === "batches" && (
            <div>
              <h2 className="text-xl font-semibold mb-4">🧪 Batch Records</h2>
              {batches.map(b => (
                <div key={b.id} className="border p-3 mb-3 rounded">
                  <div className="flex justify-between items-center">
                    <div>
                      <strong>{b.id}</strong> — {b.product}
                      {b.deviation && <span className="text-red-600 ml-2">⚠️ {b.deviation}</span>}
                    </div>
                    <span>Status: {b.status}</span>
                  </div>
                  <div className="w-full bg-gray-200 h-2 my-2">
                    <div className="bg-blue-600 h-2" style={{ width: `${b.progress}%` }}></div>
                  </div>
                  {b.status === "in_progress" && (
                    <div className="flex space-x-2">
                      <button className="bg-green-500 text-white px-3 py-1 rounded" onClick={() => completeStep(b.id)}>✅ Complete Step</button>
                      <button className="bg-red-500 text-white px-3 py-1 rounded" onClick={() => reportDeviation(b.id)}>🚨 Report Deviation</button>
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}

          {/* Templates */}
          {activeTab === "templates" && (
            <div>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-semibold">📋 eBR Templates</h2>
                <button className="bg-green-600 text-white px-3 py-1 rounded" onClick={addTemplate}><Icons.Plus /> Add Template</button>
              </div>
              {templates.map(t => (
                <div key={t.id} className="border p-3 mb-3 rounded">
                  <div className="flex justify-between">
                    <div>
                      <strong>{t.name}</strong> (v{t.version}) — {t.status}
                    </div>
                  </div>
                  <div className="mt-2">
                    <button className="bg-blue-600 text-white px-2 py-1 rounded" onClick={() => addStep(t.id)}>➕ Add Step</button>
                  </div>
                  {t.steps.length > 0 && (
                    <div className="mt-2 space-y-2">
                      {t.steps.map(s => (
                        <div key={s.id} className="border p-2 rounded bg-gray-50">
                          <input
                            className="border px-2 py-1 w-full mb-1"
                            value={s.name}
                            onChange={e => updateStep(t.id, s.id, "name", e.target.value)}
                          />
                          <input
                            className="border px-2 py-1 w-full mb-1"
                            placeholder="Parameter"
                            value={s.param}
                            onChange={e => updateStep(t.id, s.id, "param", e.target.value)}
                          />
                          <div className="flex space-x-2">
                            <input className="border px-2 py-1 w-1/2" type="number" placeholder="Min" value={s.min || ""} onChange={e => updateStep(t.id, s.id, "min", e.target.value)} />
                            <input className="border px-2 py-1 w-1/2" type="number" placeholder="Max" value={s.max || ""} onChange={e => updateStep(t.id, s.id, "max", e.target.value)} />
                          </div>
                          <input
                            className="border px-2 py-1 w-full mt-1"
                            placeholder="Materials"
                            value={s.materials?.join(", ") || ""}
                            onChange={e => updateStep(t.id, s.id, "materials", e.target.value.split(","))}
                          />
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </div>
          )}

          {/* Workflow (🔥 NEW) */}
          {activeTab === "workflow" && (
            <div>
              <h2 className="text-xl font-semibold mb-4">🔄 Workflow Execution</h2>
              {workflow.map(s => (
                <div key={s.id} className="border p-3 mb-2 rounded">
                  <div className="flex justify-between">
                    <strong>{s.name}</strong>
                    <span>Status: {s.status}</span>
                  </div>
                  {s.type === "instruction" && (
                    <button className="bg-blue-500 text-white px-2 py-1 mt-2 rounded" onClick={() => updateWorkflowStep(s.id, "confirmed")}>Confirm</button>
                  )}
                  {s.type === "input" && (
                    <input type="number" className="border px-2 py-1 mt-2 w-full"
                      placeholder={s.param}
                      onChange={e => updateWorkflowStep(s.id, parseFloat(e.target.value))}
                    />
                  )}
                  {s.type === "control" && (
                    <input type="number" className="border px-2 py-1 mt-2 w-full"
                      placeholder={`${s.param} (${s.min}-${s.max})`}
                      onChange={e => updateWorkflowStep(s.id, parseFloat(e.target.value))}
                    />
                  )}
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
